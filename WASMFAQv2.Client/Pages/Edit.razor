@page "/edit"

@inject IJSRuntime JS
@inject IServiceProvider ServiceProvider
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<PageTitle>@AppStrings.Edit</PageTitle>
@if (OperatingSystem.IsBrowser() == false)
{
	<p>@AppStrings.Loading</p>
}
else if (qnaSets == null)
{
	<MudGrid Justify="Justify.Center">
		<MudItem xs="2">
			<MudCard>
				<MudImage src="images/loader.gif" alt="@AppStrings.Loading" />
			</MudCard>
		</MudItem>
	</MudGrid>
}
else
{
	<MudThemeProvider IsDarkMode="true" />

	<MudLayout>
		<MudAppBar Elevation="4" Fixed="true">
			<MudGrid Justify="Justify.Center">
				<MudButton Color="Color.Success" 
				           Variant="Variant.Filled" 
						   @onclick="CreateQnASetAsync">
					<MudIcon Icon="@Icons.Material.Filled.Add" />
					@AppStrings.NewQnASet
				</MudButton>
				<MudButton Color="Color.Primary" 
				           Variant="Variant.Filled" 
						   Href="/">
					<MudIcon Icon="@Icons.Material.Filled.Home" />
					@AppStrings.Home
				</MudButton>
			</MudGrid>
		</MudAppBar>

		<MudGrid Justify="Justify.Center" Class="mt-16">
			<MudItem xs="12" sm="6">
				<MudCard GutterBottom="true">
					<MudCardContent>
						<MudText Typo="Typo.h4">@faq.Title</MudText>
						<MudText Typo="Typo.h6">@faq.Description</MudText>
						<br />
						<br />
						<MudGrid Justify="Justify.Center">
							<MudButton Color="Color.Success" 
							           Variant="Variant.Filled" 
									   OnClick="@(() => EditFAQAsync(faq))">
								<MudIcon Icon="@Icons.Material.Filled.Edit" />
							</MudButton>
						</MudGrid>
					</MudCardContent>
				</MudCard>
			</MudItem>
		</MudGrid>
		<br />
		<br />

		<br />
		<br />
		<MudGrid Justify="Justify.Center">
			@foreach (var qnaSet in qnaSets.OrderBy(q => q.SortOrder))
			{
				<span id="@($"qnaSet-{qnaSet.SortOrder}")">
			    </span>
				<MudItem xs="12" sm="8">
					<MudCard>
						<MudCardHeader Class="pe-0 ps-6">
							<MudGrid Justify="Justify.FlexStart">
								<MudButton 
									Color="Color.Tertiary" 
									Variant="Variant.Filled" 
									OnClick="@(() => MoveQnASetUp(qnaSet))">
									<MudIcon Icon="@Icons.Material.Filled.ArrowCircleUp" />
								</MudButton>
								<MudButton Color="Color.Tertiary" 
								           Variant="Variant.Filled" 
										   OnClick="@(() => MoveQnASetDown(qnaSet))">
									<MudIcon Icon="@Icons.Material.Filled.ArrowCircleDown" />
								</MudButton>
							</MudGrid>
							<MudGrid Justify="Justify.FlexEnd">

								<MudButton Color="Color.Error" 
								           Variant="Variant.Filled" 
										   OnClick="@(() => DeleteQnASetAsync(qnaSet.QnASetId))">
									<MudIcon Icon="@Icons.Material.Filled.Delete" />
								</MudButton>
								<MudButton Color="Color.Success" 
								           Variant="Variant.Filled" 
										   OnClick="@(() => EditQnaSetAsync(qnaSet))">
									<MudIcon Icon="@Icons.Material.Filled.Edit" />
								</MudButton>
							</MudGrid>
						</MudCardHeader>
						<MudCardContent>
							<MudText Label="@AppStrings.Name" Typo="Typo.h4"><u>@qnaSet.Name</u></MudText>
							<MudText Label="@AppStrings.Description" Typo="Typo.h6">@qnaSet.Description</MudText>
						</MudCardContent>
					</MudCard>
					<MudCard>

						<MudCardContent>
							@foreach (var qna in (qnaSet.QnAs ?? Enumerable.Empty<QnA>()).OrderBy(q => q.SortOrder))
							{
								<MudCard>
									<MudGrid Justify="Justify.SpaceBetween" Class="mb-4">
										<MudItem xs="2" md="1">
											<MudButton Color="Color.Tertiary" 
											           Variant="Variant.Filled" 
													   OnClick="@(() => MoveQnAUp(qna, qnaSet))">
												<MudIcon Icon="@Icons.Material.Filled.ArrowCircleUp" />
											</MudButton>
										</MudItem>
										<MudItem xs="2" md="1">
											<MudButton Color="Color.Tertiary" 
											           Variant="Variant.Filled" 
													   OnClick="@(() => MoveQnADown(qna, qnaSet))">
												<MudIcon Icon="@Icons.Material.Filled.ArrowCircleDown" />
											</MudButton>
										</MudItem>
										<MudItem xs="12" sm="4" md="8">
											<MudText Typo="Typo.h5">@qna.Question</MudText>
											<MudText Markup="true">
												@((MarkupString)(qna.Answer ?? string.Empty))
											</MudText>
										</MudItem>
										<MudItem xs="2" md="1">
											<MudButton Color="Color.Error" 
											           Variant="Variant.Filled" 
													   OnClick="@(() => DeleteQnAAsync(qna.QnaId))">
												<MudIcon Icon="@Icons.Material.Filled.Delete" />
											</MudButton>
										</MudItem>
										<MudItem xs="2" md="1">
											<MudButton Color="Color.Success" 
											           Variant="Variant.Filled" 
													   OnClick="@(() => EditQnAAsync(qna, qnaSet.QnASetId))">
												<MudIcon Icon="@Icons.Material.Filled.Edit" />
											</MudButton>
										</MudItem>

									</MudGrid>
								</MudCard>
								<br />
							}
							<MudGrid Justify="Justify.Center">
								<MudButton Color="Color.Success" 
								           Variant="Variant.Filled" 
										   OnClick="@(() => CreateQnAAsync(qnaSet.QnASetId))">
									<MudIcon Icon="@Icons.Material.Filled.Add" />
								</MudButton>
							</MudGrid>
						</MudCardContent>
					</MudCard>
				</MudItem>
			}

		</MudGrid>
	</MudLayout>
	<style>
		.bg-blur {
		backdrop-filter: blur(10px);
		}
	</style>

}
@code {
	private List<QnASet> qnaSets = new();
	private QnASetModel qnaSetModel = new();
	private FAQ faq = new();
	private IFAQApiService FAQApiService = null!;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender && OperatingSystem.IsBrowser())
		{
			FAQApiService = ServiceProvider.GetRequiredService<IFAQApiService>();
			await FAQApiService.NormalizeQnASetSortOrderAsync();
			await FAQApiService.NormalizeQnASortOrderAsync();
			qnaSets = await FAQApiService.GetQnASetsAsync();
			foreach (var qnaSet in qnaSets)
			{
				qnaSet.QnAs = await FAQApiService.GetQuestionsByQnASetIdAsync(qnaSet.QnASetId);
			}
			faq = await FAQApiService.GetFAQAsync();;
			StateHasChanged();
		}
	}
	
	private async Task InitializeQnASets()
	{
		qnaSets = await FAQApiService.GetQnASetsAsync();
		qnaSets = qnaSets.OrderBy(q => q.SortOrder).ToList();
		foreach (var qnaSet in qnaSets)
		{
			qnaSet.QnAs = await FAQApiService.GetQuestionsByQnASetIdAsync(qnaSet.QnASetId);
			qnaSets = qnaSets.OrderBy(q => q.SortOrder).ToList();

		}
	}

	// QnASet Methods

	private async Task DeleteQnASetAsync(int qnaSetId)
	{
		var options = new DialogOptions { BackgroundClass = "bg-blur" };
		var dialog = await DialogService.ShowAsync<ConfirmDeleteModal>(AppStrings.ConfirmDelete, options);
		var result = await dialog.Result;

		if (result is not null && !result.Canceled)
		{
			var qnaSet = qnaSets.FirstOrDefault(q => q.QnASetId == qnaSetId);

			await FAQApiService.DeleteQnASetAsync(qnaSetId);
			await InitializeQnASets();
			StateHasChanged();
			if (qnaSet != null && qnaSet.SortOrder > 1)
			{
				await ScrollToQnASet(qnaSet.SortOrder - 1);
			}
			else
			{
				await ScrollToQnASet(0);
			}
		}
	}

	private async Task EditQnaSetAsync(QnASet qnaSet)
	{
		var parameters = new DialogParameters();
		parameters.Add("qnaSet", qnaSet);
		var options = new DialogOptions { BackgroundClass = "bg-blur" };
		var dialog = await DialogService.ShowAsync<QnASetEditModal>(AppStrings.EditQnASet, parameters, options);
		var result = await dialog.Result;
		if (result is not null && !result.Canceled)
		{
			var updated = result.Data as QnASet;
			if (updated is not null)
			{
				updated.QnASetId = qnaSet.QnASetId;
				updated.SortOrder = qnaSet.SortOrder;

				await FAQApiService.UpdateQnASetAsync(updated);
				await InitializeQnASets();
				StateHasChanged();
				await ScrollToQnASet(updated.SortOrder);
			}
		}
	}

	private async Task CreateQnASetAsync()
	{
		var parameters = new DialogParameters();
		parameters.Add("QnASet", new QnASet());
		var options = new DialogOptions { BackgroundClass = "bg-blur" };
		var dialog = await DialogService.ShowAsync<QnASetModal>(AppStrings.NewQnASet, parameters, options);
		var result = await dialog.Result;
		if (result is not null && !result.Canceled && result.Data is QnASet qnaSet)
		{
			qnaSet.SortOrder = qnaSets.Count;
			await FAQApiService.AddQnASetAsync(qnaSet);
			await FAQApiService.NormalizeQnASetSortOrderAsync();
			await InitializeQnASets();
			StateHasChanged();
			await ScrollToQnASet(qnaSet.SortOrder);
		}

	}
	
	// QnA Methods

	private async Task CreateQnAAsync(int QnASetId)
	{
		var parameters = new DialogParameters();
		parameters.Add("QnASetId", QnASetId);
		parameters.Add("qna", new QnA());
		var options = new DialogOptions
			{
				BackgroundClass = "bg-blur",
				MaxWidth = MaxWidth.Large,
				FullWidth = true
			};
		var dialog = await DialogService.ShowAsync<QnAModal>(AppStrings.NewQnA, parameters, options);
		var result = await dialog.Result;

		if (result is not null && !result.Canceled && result.Data is QnA qna)
		{
			qna.QnASetId = QnASetId;
			qna.SortOrder = (qnaSets.FirstOrDefault(q => q.QnASetId == QnASetId)?.QnAs?.Count ?? 0) + 1;
			await FAQApiService.AddQnAAsync(qna);
			await FAQApiService.NormalizeQnASortOrderAsync();
			await InitializeQnASets();
			StateHasChanged();
		}
	}

	private async Task DeleteQnAAsync(int qnaId)
	{
		var options = new DialogOptions { BackgroundClass = "bg-blur" };
		var dialog = await DialogService.ShowAsync<ConfirmDeleteModal>(@AppStrings.ConfirmDelete, options);
		var result = await dialog.Result;

		if (result is not null && !result.Canceled)
		{
			await FAQApiService.DeleteQnAAsync(qnaId);
			await InitializeQnASets();
			StateHasChanged();
		}
	}

	private async Task EditQnAAsync(QnA qna, int qnaSetId)
	{
		var parameters = new DialogParameters();
		parameters.Add("qna", qna);
		parameters.Add("QnASetId", qnaSetId); 
		var options = new DialogOptions
			{
				BackgroundClass = "bg-blur",
				MaxWidth = MaxWidth.Large,
				FullWidth = true
			}; 
		var dialog = await DialogService.ShowAsync<QnAEditModal>(AppStrings.EditQnA, parameters, options);
		var result = await dialog.Result;
		if (result is not null && !result.Canceled && result.Data is QnA updated)
		{
			updated.QnASetId = qnaSetId;
			updated.SortOrder = qna.SortOrder;

			await FAQApiService.UpdateQnAAsync(updated);
			await InitializeQnASets();
			StateHasChanged();
		}
	}

	// FAQ Methods
	private async Task EditFAQAsync(FAQ faq)
	{
		var parameters = new DialogParameters();
		parameters.Add("faq", faq);
		var options = new DialogOptions { BackgroundClass = "bg-blur" };
		var dialog = await DialogService.ShowAsync<FAQEditModal>(AppStrings.EditModalTitle, parameters, options);
		var result = await dialog.Result;
		if (result is not null && !result.Canceled && result.Data is FAQ updated)
		{
			await FAQApiService.UpdateFAQAsync(updated);
			StateHasChanged();
		}
	}

	// Sort Methods
	private async Task MoveQnASetUp(QnASet qnaSet)
	{
		var ordered = qnaSets.OrderBy(q => q.SortOrder).ToList();
		var index = ordered.FindIndex(q => q.QnASetId == qnaSet.QnASetId);
		if (index <= 0) return;

		var above = ordered[index - 1];

		int temp = qnaSet.SortOrder;
		qnaSet.SortOrder = above.SortOrder;
		above.SortOrder = temp;

		await FAQApiService.UpdateQnASetAsync(qnaSet);
		await FAQApiService.UpdateQnASetAsync(above);
		await FAQApiService.NormalizeQnASetSortOrderAsync();
		await InitializeQnASets(); 
		StateHasChanged();
	}

	private async Task MoveQnASetDown(QnASet qnaSet)
	{
		var ordered = qnaSets.OrderBy(q => q.SortOrder).ToList();
		var index = ordered.FindIndex(q => q.QnASetId == qnaSet.QnASetId);
		if (index < 0 || index >= ordered.Count - 1) return;

		var below = ordered[index + 1];

		int temp = qnaSet.SortOrder;
		qnaSet.SortOrder = below.SortOrder;
		below.SortOrder = temp;

		await FAQApiService.UpdateQnASetAsync(qnaSet);
		await FAQApiService.UpdateQnASetAsync(below);
		await FAQApiService.NormalizeQnASetSortOrderAsync();
		await InitializeQnASets(); 
		StateHasChanged();
	}

	private async Task MoveQnAUp(QnA qna, QnASet qnaSet)
	{
		if (qnaSet == null) return;
		if (qnaSet.QnAs == null) return;
		var ordered = qnaSet.QnAs.OrderBy(q => q.SortOrder).ToList();
		var index = ordered.FindIndex(q => q.QnaId == qna.QnaId);
		if (index <= 0) return;
		var above = ordered[index - 1];

		int temp = qna.SortOrder;
		qna.SortOrder = above.SortOrder;
		above.SortOrder = temp;

		await FAQApiService.UpdateQnAAsync(qna);
		await FAQApiService.UpdateQnAAsync(above);
		await FAQApiService.NormalizeQnASortOrderAsync();
		await InitializeQnASets();
		StateHasChanged();
	}

	private async Task MoveQnADown(QnA qna, QnASet qnaSet)
	{
		if (qnaSet == null) return;
		if (qnaSet.QnAs == null) return;
		var ordered = qnaSet.QnAs.OrderBy(q => q.SortOrder).ToList();
		var index = ordered.FindIndex(q => q.QnaId == qna.QnaId);
		if (index < 0 || index >= ordered.Count - 1) return;

		var below = ordered[index + 1];

		int temp = qna.SortOrder;
		qna.SortOrder = below.SortOrder;
		below.SortOrder = temp;

		await FAQApiService.UpdateQnAAsync(qna);
		await FAQApiService.UpdateQnAAsync(below);
		await FAQApiService.NormalizeQnASortOrderAsync();
		await InitializeQnASets(); 
		StateHasChanged();
	}
	
	private async Task ScrollToQnASet(int qnaSetSortOrder)
	{
		var elementId = $"qnaSet-{qnaSetSortOrder}";
		await JS.InvokeVoidAsync("scrollToElement", elementId);
	}

	// Models
	private class QnASetModel
	{
		public string? Name { get; set; }
		public string? Description { get; set; }
		public int QnASetId { get; set; }
	}
}
